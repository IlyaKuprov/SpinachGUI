<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Spinach GUI: Z:/SpinachGUI/GUI/IO Formats/SpinXML.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>Z:/SpinachGUI/GUI/IO Formats/SpinXML.cpp</h1>  </div>
</div>
<div class="contents">
<a href="_spin_x_m_l_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;../StdAfx.h&quot;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="_spin_x_m_l_8h.html">SpinXML.h</a>&quot;</span>
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="comment">//Definitions</span>
<a name="l00005"></a><a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">00005</a> <span class="preprocessor">#define To_Double(aNumber) Convert::ToDouble(SpinachGUI::ConvertToString(aNumber, 5, &quot;N&quot;))</span>
<a name="l00006"></a><a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">00006</a> <span class="preprocessor"></span><span class="preprocessor">#define InteractionCollection  SystemModel-&gt;InteractionCollection</span>
<a name="l00007"></a><a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">00007</a> <span class="preprocessor"></span><span class="preprocessor">#define AtomCollection  SystemModel-&gt;AtomCollection</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">/**</span>
<a name="l00010"></a>00010 <span class="comment">*\file SpinXML.cpp</span>
<a name="l00011"></a>00011 <span class="comment">*/</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">/**</span>
<a name="l00014"></a>00014 <span class="comment">* Constructor of SpinXML format for reading or writing.</span>
<a name="l00015"></a>00015 <span class="comment">* @param filename Name of the file to be read or write.</span>
<a name="l00016"></a>00016 <span class="comment">* @param model The model where the imported data will be saved or the data will be exported from.</span>
<a name="l00017"></a>00017 <span class="comment">*/</span>
<a name="l00018"></a>00018 <a class="code" href="class_spin_x_m_l.html#a0a64097b9f213e6b04390bec83ad1012">SpinXML::SpinXML</a>(System::String^ filename, FilterType type, <a class="code" href="class_model.html">Model</a>^% model)
<a name="l00019"></a>00019 {
<a name="l00020"></a>00020         <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>=model;
<a name="l00021"></a>00021         <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>=filename;
<a name="l00022"></a>00022         <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#ac0b9b8564acd4f403ab68762adcf65a2" title="The name of the format.">FormatName</a>=<span class="stringliteral">&quot;SpinXML&quot;</span>;
<a name="l00023"></a>00023 
<a name="l00024"></a>00024         <span class="comment">//Depending the filtertype create file for reading or writing</span>
<a name="l00025"></a>00025         <span class="keywordflow">if</span>(type==FilterType::IMPORT) <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a02eb5f8efccd91a84ea7c427613ddce3" title="The stream that has the file which will be read.">ReadingFile</a> = <span class="keyword">gcnew</span> StreamReader(filename);
<a name="l00026"></a>00026         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(type==FilterType::EXPORT) <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a7be06c655425ce64a0f42da320c436cf" title="The stream that has the file which will be written.">WritingFile</a> = <span class="keyword">gcnew</span> StreamWriter(filename);
<a name="l00027"></a>00027     
<a name="l00028"></a>00028 }
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">/**</span>
<a name="l00031"></a>00031 <span class="comment">* Main function for opening and reading file using the auto-generated spinxml schema file</span>
<a name="l00032"></a>00032 <span class="comment">* @return Returns false if the format does not seem to be correct.</span>
<a name="l00033"></a>00033 <span class="comment">*/</span>
<a name="l00034"></a><a class="code" href="class_spin_x_m_l.html#a1a966a3eb87541e98783095710ca95c3">00034</a> <span class="keywordtype">bool</span> <a class="code" href="class_spin_x_m_l.html#a1a966a3eb87541e98783095710ca95c3">SpinXML::LoadFile</a>(<span class="keywordtype">void</span>)
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036         XmlReader^ reader;
<a name="l00037"></a>00037 
<a name="l00038"></a>00038         <span class="comment">//Initialization of the spinxml schema, main and reference frmas</span>
<a name="l00039"></a>00039         <a class="code" href="classspin__system.html">spin_system</a>^ XMLSpinSystem=<span class="keyword">gcnew</span> <a class="code" href="classspin__system.html">spin_system</a>();
<a name="l00040"></a>00040         <a class="code" href="classspin__system__ref.html">spin_system_ref</a>^ XMLSpinSystemRef=<span class="keyword">gcnew</span> <a class="code" href="classspin__system__ref.html">spin_system_ref</a>();
<a name="l00041"></a>00041         XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ab88f06c624e2c5f1f90683b6894e474d">InitVars</a>();
<a name="l00042"></a>00042         XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#acc8705603d9b94ce6ee74e767982aeeb">InitVars</a>();
<a name="l00043"></a>00043 
<a name="l00044"></a>00044         <span class="comment">//Opening and reading the xml file, checking for any errors</span>
<a name="l00045"></a>00045         reader = XmlReader::Create(<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a02eb5f8efccd91a84ea7c427613ddce3" title="The stream that has the file which will be read.">ReadingFile</a>);
<a name="l00046"></a>00046         <span class="keywordflow">try</span>  {XMLSpinSystem-&gt;ReadXml(reader); }
<a name="l00047"></a>00047         <span class="keywordflow">catch</span> (::System::InvalidOperationException^ e) {
<a name="l00048"></a>00048                 <span class="keywordflow">throw</span> <span class="keyword">gcnew</span> Exception(<span class="stringliteral">&quot;File : &quot;</span>+<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>+<span class="stringliteral">&quot;\n Error in XML Format: &quot;</span>+e-&gt;Message);
<a name="l00049"></a>00049         }
<a name="l00050"></a>00050         <span class="keywordflow">catch</span> (::System::Xml::XmlException^ e) {
<a name="l00051"></a>00051                 <span class="keywordflow">throw</span> <span class="keyword">gcnew</span> Exception(<span class="stringliteral">&quot;File : &quot;</span>+<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>+<span class="stringliteral">&quot;\n Error in XML Format: &quot;</span>+e-&gt;Message );
<a name="l00052"></a>00052         }
<a name="l00053"></a>00053         <span class="keywordflow">catch</span> (::System::Data::ConstraintException^ e) {
<a name="l00054"></a>00054                 <span class="keywordflow">throw</span> <span class="keyword">gcnew</span> Exception(<span class="stringliteral">&quot;File : &quot;</span>+<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>+<span class="stringliteral">&quot;\n Error in XML Format: &quot;</span>+e-&gt;Message);
<a name="l00055"></a>00055         }
<a name="l00056"></a>00056 
<a name="l00057"></a>00057         <span class="comment">//Close file and reader</span>
<a name="l00058"></a>00058         reader-&gt;Close();
<a name="l00059"></a>00059         <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a02eb5f8efccd91a84ea7c427613ddce3" title="The stream that has the file which will be read.">ReadingFile</a>-&gt;Close();
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         <span class="comment">//Opening and reading the xml file again, checking for any errors, using reference frame schema</span>
<a name="l00062"></a>00062         <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a02eb5f8efccd91a84ea7c427613ddce3" title="The stream that has the file which will be read.">ReadingFile</a> = <span class="keyword">gcnew</span> StreamReader(<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>);
<a name="l00063"></a>00063         reader = XmlReader::Create(<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a02eb5f8efccd91a84ea7c427613ddce3" title="The stream that has the file which will be read.">ReadingFile</a>);
<a name="l00064"></a>00064         <span class="keywordflow">try</span>  {XMLSpinSystemRef-&gt;ReadXml(reader); }
<a name="l00065"></a>00065         <span class="keywordflow">catch</span> (::System::InvalidOperationException^ e) {
<a name="l00066"></a>00066                 <span class="keywordflow">throw</span> <span class="keyword">gcnew</span> Exception(<span class="stringliteral">&quot;File : &quot;</span>+<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>+<span class="stringliteral">&quot;\n Error in XML Format: &quot;</span>+e-&gt;Message);
<a name="l00067"></a>00067         }
<a name="l00068"></a>00068         <span class="keywordflow">catch</span> (::System::Xml::XmlException^ e) {
<a name="l00069"></a>00069                 <span class="keywordflow">throw</span> <span class="keyword">gcnew</span> Exception(<span class="stringliteral">&quot;File : &quot;</span>+<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>+<span class="stringliteral">&quot;\n Error in XML Format: &quot;</span>+e-&gt;Message );
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071         <span class="keywordflow">catch</span> (::System::Data::ConstraintException^ e) {
<a name="l00072"></a>00072                 <span class="keywordflow">throw</span> <span class="keyword">gcnew</span> Exception(<span class="stringliteral">&quot;File : &quot;</span>+<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>+<span class="stringliteral">&quot;\n Error in XML Format: &quot;</span>+e-&gt;Message);
<a name="l00073"></a>00073         }
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         <span class="comment">//Close file and reader</span>
<a name="l00076"></a>00076         reader-&gt;Close();
<a name="l00077"></a>00077         <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a02eb5f8efccd91a84ea7c427613ddce3" title="The stream that has the file which will be read.">ReadingFile</a>-&gt;Close();
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 
<a name="l00080"></a>00080         <span class="comment">//Loop over all atoms to import of atoms and coordinates</span>
<a name="l00081"></a>00081         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ac5e843365d0a5593751f1ee2d1c40201">spin</a>-&gt;Count;i++)
<a name="l00082"></a>00082         {
<a name="l00083"></a>00083                 <a class="code" href="class_atom.html">Atom</a>^ nAtom=<span class="keyword">gcnew</span> <a class="code" href="class_atom.html">Atom</a>();
<a name="l00084"></a>00084                 String ^ mass=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00085"></a>00085                 String ^element=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00086"></a>00086                 <span class="keywordtype">int</span> value;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088                 <span class="comment">//Import coordinates</span>
<a name="l00089"></a>00089                 nAtom-&gt;<a class="code" href="class_atom.html#a9adaaa1c67caa251c7c3f9b5753cfced" title="Property x coordinate position of the atom.">X</a>=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ab1c13f2d471c344b92630d8ed92c339b">coordinates</a>[i]-&gt;x;
<a name="l00090"></a>00090                 nAtom-&gt;<a class="code" href="class_atom.html#ad121a01910fb0f6511a963de4d89460d" title="Property y coordinate position of the atom.">Y</a>=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ab1c13f2d471c344b92630d8ed92c339b">coordinates</a>[i]-&gt;y;
<a name="l00091"></a>00091                 nAtom-&gt;<a class="code" href="class_atom.html#aa0c17b25aa4c710115c74b173c756a9b" title="Property z coordinate position of the atom.">Z</a>=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ab1c13f2d471c344b92630d8ed92c339b">coordinates</a>[i]-&gt;z;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093                 <span class="comment">//Read each character in the isotope string in order to seperate numerics and characters</span>
<a name="l00094"></a>00094                 <span class="comment">//and find mass number and isotopes</span>
<a name="l00095"></a>00095                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ac5e843365d0a5593751f1ee2d1c40201">spin</a>[i]-&gt;isotope-&gt;Length;j++)
<a name="l00096"></a>00096                 {
<a name="l00097"></a>00097                         <span class="keywordflow">if</span>(Int32::TryParse(System::Convert::ToString(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ac5e843365d0a5593751f1ee2d1c40201">spin</a>[i]-&gt;isotope[j]), value))
<a name="l00098"></a>00098                                 mass=mass+System::Convert::ToString(value);
<a name="l00099"></a>00099                         <span class="keywordflow">else</span>
<a name="l00100"></a>00100                                 element=element+System::Convert::ToString(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ac5e843365d0a5593751f1ee2d1c40201">spin</a>[i]-&gt;isotope[j]);
<a name="l00101"></a>00101                 };
<a name="l00102"></a>00102                 value=System::Convert::ToInt32(mass);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104                 <span class="comment">//Find the isotope form the element and mass number</span>
<a name="l00105"></a>00105                 nAtom-&gt;<a class="code" href="class_atom.html#a14a6785b5d26d50fe23d617c95b2585d" title="Property isotope of the atom.">isotope</a>=<a class="code" href="class_isotopes.html#a5d8772910912cbc6667f066a2a8ef531" title="Function for finding the isotope when one of the element, atom number or mass is given.">Isotopes::FindIsotope</a>(element,0, value);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107                 <span class="comment">//Import the label if exist</span>
<a name="l00108"></a>00108                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ac5e843365d0a5593751f1ee2d1c40201">spin</a>[i]-&gt;IslabelNull()) nAtom-&gt;<a class="code" href="class_atom.html#a4e2c6ba5230129441e4438e398c73b73" title="Property label of the atom.">Label</a>=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00109"></a>00109                 <span class="keywordflow">else</span> nAtom-&gt;<a class="code" href="class_atom.html#a4e2c6ba5230129441e4438e398c73b73" title="Property label of the atom.">Label</a>=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ac5e843365d0a5593751f1ee2d1c40201">spin</a>[i]-&gt;label;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111                 <span class="comment">//Add atom to collection</span>
<a name="l00112"></a>00112                 <a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>-&gt;Add(nAtom);
<a name="l00113"></a>00113         }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115         <span class="comment">//Loop over all ref. frame to import of reference frames</span>
<a name="l00116"></a>00116         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a59b971f554d94ee6f0c21a17bf9d2f6d">reference_frame</a>-&gt;Count;i++)
<a name="l00117"></a>00117         {
<a name="l00118"></a>00118                 <span class="comment">//dcm</span><a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html"></a>
<a name="l00119"></a>00119 <a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html">		::Matrix3x3</a>^ mat=gcnew ::Matrix3x3();
<a name="l00120"></a>00120                 <span class="keywordtype">int</span> ParentID;
<a name="l00121"></a>00121                 <a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ frame;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123                 <span class="comment">//Loop over direction matrices</span>
<a name="l00124"></a>00124                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>-&gt;Count;j++)
<a name="l00125"></a>00125                 {
<a name="l00126"></a>00126                         <span class="comment">//Match the ids of the direction with the reference frame</span>
<a name="l00127"></a>00127                         <span class="keywordflow">if</span>(XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;reference_frameRow-&gt;id==XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a59b971f554d94ee6f0c21a17bf9d2f6d">reference_frame</a>[i]-&gt;id) 
<a name="l00128"></a>00128                         {
<a name="l00129"></a>00129                                 <span class="comment">//Read matrix in mat</span>
<a name="l00130"></a>00130                                 <span class="keywordflow">if</span>(XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()-&gt;Length&gt;0)
<a name="l00131"></a>00131                                 {
<a name="l00132"></a>00132                                         mat[0]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;xx;
<a name="l00133"></a>00133                                         mat[1]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;xy;
<a name="l00134"></a>00134                                         mat[2]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;xz;
<a name="l00135"></a>00135                                         mat[3]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;yx;
<a name="l00136"></a>00136                                         mat[4]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;yy;
<a name="l00137"></a>00137                                         mat[5]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;yz;
<a name="l00138"></a>00138                                         mat[6]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;zx;
<a name="l00139"></a>00139                                         mat[7]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;zy;
<a name="l00140"></a>00140                                         mat[8]=XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a999a8956f6ce8efa473bd63d9e9a5846">direction</a>[j]-&gt;GetdcmRows()[0]-&gt;zz;
<a name="l00141"></a>00141                                 };
<a name="l00142"></a>00142 
<a name="l00143"></a>00143                                 <span class="comment">//Create ref. frame form the matrix</span>
<a name="l00144"></a>00144                                 frame=<span class="keyword">gcnew</span> <a class="code" href="class_reference_frame.html">ReferenceFrame</a>(mat);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146                                 <span class="comment">//Parent reference frame. If not existing is the root and set it                </span>
<a name="l00147"></a>00147                                 <span class="keywordflow">if</span>(XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a59b971f554d94ee6f0c21a17bf9d2f6d">reference_frame</a>[i]-&gt;Isparent_reference_frame_idNull() || j==0)
<a name="l00148"></a>00148                                 {
<a name="l00149"></a>00149                                         frame-&gt;<a class="code" href="class_reference_frame.html#a4806dd7454843eab35b91a65170c2e5b" title="The parent reference frame of this reference frame.">ParentRefFrame</a>=<span class="keyword">nullptr</span>;
<a name="l00150"></a>00150                                         <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[1]=frame;
<a name="l00151"></a>00151                                 }
<a name="l00152"></a>00152                                 <span class="keywordflow">else</span> <span class="comment">//other reference frames, add them</span>
<a name="l00153"></a>00153                                 {
<a name="l00154"></a>00154                                         frame-&gt;<a class="code" href="class_reference_frame.html#a4806dd7454843eab35b91a65170c2e5b" title="The parent reference frame of this reference frame.">ParentRefFrame</a>=<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#a59b971f554d94ee6f0c21a17bf9d2f6d">reference_frame</a>[i]-&gt;parent_reference_frame_id];
<a name="l00155"></a>00155                                         <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>-&gt;<a class="code" href="class_reference_frames_dictionary.html#a58496087004766c6f8bef676f16484a5">Add</a>(frame);
<a name="l00156"></a>00156                                 };
<a name="l00157"></a>00157                         };
<a name="l00158"></a>00158                 };
<a name="l00159"></a>00159         };
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         <span class="comment">//Loop over all interactions to import of interaction</span>
<a name="l00162"></a>00162         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>-&gt;Count;i++)
<a name="l00163"></a>00163         {
<a name="l00164"></a>00164                 <span class="comment">//Search for A atom according to ID</span>
<a name="l00165"></a>00165                 <span class="keywordtype">int</span> AID=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;spin_a;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167                 <span class="comment">//If ID is zero, change to 1 for unit indexing</span>
<a name="l00168"></a>00168                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[0]-&gt;spin_a==0) AID++;
<a name="l00169"></a>00169 
<a name="l00170"></a>00170                 <span class="keywordtype">int</span> BID;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172                 <span class="comment">//If B not existing put equal to A</span>
<a name="l00173"></a>00173                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Isspin_bNull()) BID=AID;
<a name="l00174"></a>00174                 <span class="keywordflow">else</span> 
<a name="l00175"></a>00175                 {
<a name="l00176"></a>00176                         BID=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;spin_b;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178                         <span class="comment">//If ID is zero, change to 1 for unit indexing</span>
<a name="l00179"></a>00179                         <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[0]-&gt;spin_a==0) BID++;
<a name="l00180"></a>00180                 };
<a name="l00181"></a>00181 
<a name="l00182"></a>00182                 <span class="comment">//Set the atoms form the imported collection</span>
<a name="l00183"></a>00183                 <a class="code" href="class_atom.html">Atom</a>^ A=((<a class="code" href="class_atom.html">Atom</a> ^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[AID]);
<a name="l00184"></a>00184                 <a class="code" href="class_atom.html">Atom</a>^ B=((<a class="code" href="class_atom.html">Atom</a> ^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[BID]);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 
<a name="l00187"></a>00187                 <span class="comment">//Parent reference Frame</span>
<a name="l00188"></a>00188                 <a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ refFrame;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190                 <span class="comment">//If reference not declared use root</span>
<a name="l00191"></a>00191                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Isreference_frame_idNull())
<a name="l00192"></a>00192                         refFrame=<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[1];
<a name="l00193"></a>00193                 <span class="keywordflow">else</span>
<a name="l00194"></a>00194                         refFrame=<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;reference_frame_id];
<a name="l00195"></a>00195 
<a name="l00196"></a>00196                 <span class="comment">//Search of Interaction kind</span>
<a name="l00197"></a>00197                 <a class="code" href="class_interaction_kind.html">InteractionKind</a> IntKind;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199                 <span class="comment">//Check and translate for interaction kind, if does not exist throw exception</span>
<a name="l00200"></a>00200                 if (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;hfc&quot;</span>) IntKind=InteractionKind::HFC;
<a name="l00201"></a>00201                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;jcoupling&quot;</span>) IntKind=InteractionKind::Jcoupling;
<a name="l00202"></a>00202                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;quadrupolar&quot;</span>) IntKind=InteractionKind::Quadrupolar;
<a name="l00203"></a>00203                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;gtensor&quot;</span>) IntKind=InteractionKind::GTensor;
<a name="l00204"></a>00204                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;zfs&quot;</span>) IntKind=InteractionKind::ZFS;
<a name="l00205"></a>00205                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;exchange&quot;</span>) IntKind=InteractionKind::Exchange;
<a name="l00206"></a>00206                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;dipolar&quot;</span>) IntKind=InteractionKind::Dipolar;
<a name="l00207"></a>00207                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;spinrotation&quot;</span>) IntKind=InteractionKind::spinrotation;
<a name="l00208"></a>00208                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;shielding&quot;</span>) 
<a name="l00209"></a>00209                 {IntKind=InteractionKind::CShielding; <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a45651fc765aa371f37367c5cab143296" title="Flag to show if the convertion from chemical shielding to shift will be used.">ToShift</a>=<span class="keyword">true</span>;}
<a name="l00210"></a>00210                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind==<span class="stringliteral">&quot;shift&quot;</span>) IntKind=InteractionKind::Shift;
<a name="l00211"></a>00211                 <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <span class="keyword">gcnew</span> Exception(<span class="stringliteral">&quot;File : &quot;</span>+<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>+<span class="stringliteral">&quot;\n Error in XML Format: \&quot;&quot;</span> +
<a name="l00212"></a>00212                         XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;kind+<span class="stringliteral">&quot;\&quot; is not an accepted interaction kind!&quot;</span>); 
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 
<a name="l00217"></a>00217                 <span class="comment">//Check if interaction is written in matrix form and save it in a matrix</span><a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html"></a>
<a name="l00218"></a>00218 <a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html">		::Matrix3x3</a> ^matrix3x3= gcnew ::Matrix3x3();
<a name="l00219"></a>00219                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()-&gt;Length&gt;0)
<a name="l00220"></a>00220                 {
<a name="l00221"></a>00221                         matrix3x3[0]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;xx;
<a name="l00222"></a>00222                         matrix3x3[1]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;xy;
<a name="l00223"></a>00223                         matrix3x3[2]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;xz;
<a name="l00224"></a>00224                         matrix3x3[3]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;yx;
<a name="l00225"></a>00225                         matrix3x3[4]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;yy;
<a name="l00226"></a>00226                         matrix3x3[5]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;yz;
<a name="l00227"></a>00227                         matrix3x3[6]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;zx;
<a name="l00228"></a>00228                         matrix3x3[7]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;zy;
<a name="l00229"></a>00229                         matrix3x3[8]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GettensorRows()[0]-&gt;zz;
<a name="l00230"></a>00230                 };
<a name="l00231"></a>00231 
<a name="l00232"></a>00232                 <span class="comment">//Check if interaction is written in eigen values form and save it in a matrix</span>
<a name="l00233"></a>00233                 <span class="keywordtype">double</span> *eigenvalues= <span class="keyword">new</span> <span class="keywordtype">double</span>[3];
<a name="l00234"></a>00234                 <span class="comment">//Eigenvalues</span>
<a name="l00235"></a>00235                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GeteigenvaluesRows()-&gt;Length&gt;0)
<a name="l00236"></a>00236                 {
<a name="l00237"></a>00237                         eigenvalues[0]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GeteigenvaluesRows()[0]-&gt;xx;
<a name="l00238"></a>00238                         eigenvalues[1]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GeteigenvaluesRows()[0]-&gt;yy;
<a name="l00239"></a>00239                         eigenvalues[2]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;GeteigenvaluesRows()[0]-&gt;zz;
<a name="l00240"></a>00240                 };
<a name="l00241"></a>00241 
<a name="l00242"></a>00242                 <span class="comment">//Check if interaction is written in Axiality-Rombicity form and </span>
<a name="l00243"></a>00243                 <span class="comment">// save it in a calculated eigen matrix</span>
<a name="l00244"></a>00244                 <span class="keywordtype">double</span> ax, rh, iso;
<a name="l00245"></a>00245                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Getaxiality_rhombicityRows()-&gt;Length&gt;0)
<a name="l00246"></a>00246                 {
<a name="l00247"></a>00247                         ax=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Getaxiality_rhombicityRows()[0]-&gt;ax;
<a name="l00248"></a>00248                         rh=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Getaxiality_rhombicityRows()[0]-&gt;rh;
<a name="l00249"></a>00249                         iso=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Getaxiality_rhombicityRows()[0]-&gt;iso;
<a name="l00250"></a>00250                         eigenvalues[0]=-ax/6.0f+rh/2.0f+iso;
<a name="l00251"></a>00251                         eigenvalues[1]=-ax/6.0f-rh/2.0f+iso;
<a name="l00252"></a>00252                         eigenvalues[2]=ax/3.0f+iso;
<a name="l00253"></a>00253                 };
<a name="l00254"></a>00254 
<a name="l00255"></a>00255                 <span class="comment">//Check if interaction is written in Span-Skew form and </span>
<a name="l00256"></a>00256                 <span class="comment">// save it in a calculated eigen matrix</span>
<a name="l00257"></a>00257                 <span class="keywordtype">double</span> span, skew;
<a name="l00258"></a>00258                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Getspan_skewRows()-&gt;Length&gt;0)
<a name="l00259"></a>00259                 {
<a name="l00260"></a>00260                         span=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Getspan_skewRows()[0]-&gt;span;
<a name="l00261"></a>00261                         skew=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Getspan_skewRows()[0]-&gt;skew;
<a name="l00262"></a>00262                         iso=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;Getspan_skewRows()[0]-&gt;iso;
<a name="l00263"></a>00263                         eigenvalues[0]=span*skew-span/2.0f;
<a name="l00264"></a>00264                         eigenvalues[1]=3.0f*iso-2.0f*span*skew;
<a name="l00265"></a>00265                         eigenvalues[2]=span*skew+span/2.0f;
<a name="l00266"></a>00266                 };
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 
<a name="l00269"></a>00269                 <span class="comment">//Loop over directions to find respective form of orientation</span>
<a name="l00270"></a>00270                 <span class="keywordtype">double</span> *dcm=<span class="keyword">new</span> <span class="keywordtype">double</span>[9];
<a name="l00271"></a>00271                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>-&gt;Count;j++)
<a name="l00272"></a>00272                 {
<a name="l00273"></a>00273                         <span class="comment">//Match the ids of the direction with the interaction</span>
<a name="l00274"></a>00274                         <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;interactionRow-&gt;id==XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;id) 
<a name="l00275"></a>00275                         {
<a name="l00276"></a>00276                                 <span class="comment">//Check if interaction is written in dcm form and save it in a matrix</span>
<a name="l00277"></a>00277                                 <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()-&gt;Length&gt;0)
<a name="l00278"></a>00278                                 {
<a name="l00279"></a>00279                                         dcm[0]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;xx;
<a name="l00280"></a>00280                                         dcm[1]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;xy;
<a name="l00281"></a>00281                                         dcm[2]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;xz;
<a name="l00282"></a>00282                                         dcm[3]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;yx;
<a name="l00283"></a>00283                                         dcm[4]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;yy;
<a name="l00284"></a>00284                                         dcm[5]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;yz;
<a name="l00285"></a>00285                                         dcm[6]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;zx;
<a name="l00286"></a>00286                                         dcm[7]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;zy;
<a name="l00287"></a>00287                                         dcm[8]=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetdcmRows()[0]-&gt;zz;      
<a name="l00288"></a>00288                                 }<span class="comment">//Check if interaction is written in euler angles form and save it in a calculated dcm matrix</span>
<a name="l00289"></a>00289                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Geteuler_anglesRows()-&gt;Length&gt;0)
<a name="l00290"></a>00290                                 {
<a name="l00291"></a>00291                                         <span class="comment">//Read angles</span>
<a name="l00292"></a>00292                                         <span class="keywordtype">double</span> alpha, beta, gamma;
<a name="l00293"></a>00293                                         alpha=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Geteuler_anglesRows()[0]-&gt;alpha*<a class="code" href="_i_o_spin_system_8h.html#a598a3330b3c21701223ee0ca14316eca">PI</a>/180.0f;
<a name="l00294"></a>00294                                         beta=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Geteuler_anglesRows()[0]-&gt;beta*<a class="code" href="_i_o_spin_system_8h.html#a598a3330b3c21701223ee0ca14316eca">PI</a>/180.0f;
<a name="l00295"></a>00295                                         gamma=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Geteuler_anglesRows()[0]-&gt;gamma*<a class="code" href="_i_o_spin_system_8h.html#a598a3330b3c21701223ee0ca14316eca">PI</a>/180.0f;
<a name="l00296"></a>00296 
<a name="l00297"></a>00297                                         <span class="comment">//Make the transformation to dcm</span>
<a name="l00298"></a>00298                                         <a class="code" href="class_spinach_g_u_i_1_1_orientation.html">SpinachGUI::Orientation</a>^  nOrient;
<a name="l00299"></a>00299                                         nOrient= <span class="keyword">gcnew</span> <a class="code" href="class_spinach_g_u_i_1_1_orientation.html">SpinachGUI::Orientation</a>(<span class="keyword">gcnew</span> <a class="code" href="class_spinach_g_u_i_1_1_euler_angles.html">SpinachGUI::EulerAngles</a>(alpha,beta, gamma));
<a name="l00300"></a>00300                                         <a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html">SpinachGUI::Matrix3x3</a>^ dc=nOrient-&gt;<a class="code" href="class_spinach_g_u_i_1_1_orientation.html#a0b84015f936d299ba8373f009c00592d" title="Function for returning orientation as DCM matrix.">GetAsDCM</a>();
<a name="l00301"></a>00301 
<a name="l00302"></a>00302                                         <span class="comment">//Save to dcm matrix</span>
<a name="l00303"></a>00303                                         dcm[0]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a073f3e87a02ce938d95a784e4781e01e">xx</a>;dcm[1]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a88ebcaa300a6eeecf5f737457bc31788">xy</a>;dcm[2]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#ad77d16a3d314ad637a068f5bf8fa3ecf">xz</a>;dcm[3]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#aa4b0aed4c1ba1d51a7c895c231fdfcf2">yx</a>;
<a name="l00304"></a>00304                                         dcm[4]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a35921945e33551e183e74ccc0718c3f1">yy</a>;dcm[5]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a086b02cfae6dbceebd851af2c767045a">yz</a>;dcm[6]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a16e2c28a66a5d6a1f72e5cbdbf3e97b6">zx</a>;dcm[7]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a83c94f51a5c25470b089edc15a38597d">zy</a>;dcm[8]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#aba491fe39528f75bc76ddcdf0e78854c" title="Elements of the matrix.">zz</a>;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306                                 }<span class="comment">//Check if interaction is written in angle axis form and save it in a calculated dcm matrix</span>
<a name="l00307"></a>00307                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Getangle_axisRows()-&gt;Length&gt;0)
<a name="l00308"></a>00308                                 {
<a name="l00309"></a>00309                                         <span class="comment">//Read angles</span>
<a name="l00310"></a>00310                                         <span class="keywordtype">double</span> ax,ay,az,angle;
<a name="l00311"></a>00311                                         ax=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Getangle_axisRows()[0]-&gt;GetaxisRows()[0]-&gt;x;
<a name="l00312"></a>00312                                         ay=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Getangle_axisRows()[0]-&gt;GetaxisRows()[0]-&gt;y;
<a name="l00313"></a>00313                                         az=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Getangle_axisRows()[0]-&gt;GetaxisRows()[0]-&gt;z;
<a name="l00314"></a>00314                                         angle=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;Getangle_axisRows()[0]-&gt;angle*<a class="code" href="_i_o_spin_system_8h.html#a598a3330b3c21701223ee0ca14316eca">PI</a>/180.0f;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316                                         <span class="comment">//Make the transformation to dcm</span>
<a name="l00317"></a>00317                                         <a class="code" href="class_spinach_g_u_i_1_1_orientation.html">SpinachGUI::Orientation</a>^  nOrient;
<a name="l00318"></a>00318                                         nOrient= <span class="keyword">gcnew</span> <a class="code" href="class_spinach_g_u_i_1_1_orientation.html">SpinachGUI::Orientation</a>(<span class="keyword">gcnew</span> <a class="code" href="class_spinach_g_u_i_1_1_angle_axis.html">SpinachGUI::AngleAxis</a>(ax,ay,az,angle));
<a name="l00319"></a>00319                                         <a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html">SpinachGUI::Matrix3x3</a>^ dc=nOrient-&gt;<a class="code" href="class_spinach_g_u_i_1_1_orientation.html#a0b84015f936d299ba8373f009c00592d" title="Function for returning orientation as DCM matrix.">GetAsDCM</a>();
<a name="l00320"></a>00320 
<a name="l00321"></a>00321                                         <span class="comment">//Save to dcm matrix</span>
<a name="l00322"></a>00322                                         dcm[0]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a073f3e87a02ce938d95a784e4781e01e">xx</a>;dcm[1]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a88ebcaa300a6eeecf5f737457bc31788">xy</a>;dcm[2]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#ad77d16a3d314ad637a068f5bf8fa3ecf">xz</a>;dcm[3]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#aa4b0aed4c1ba1d51a7c895c231fdfcf2">yx</a>;
<a name="l00323"></a>00323                                         dcm[4]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a35921945e33551e183e74ccc0718c3f1">yy</a>;dcm[5]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a086b02cfae6dbceebd851af2c767045a">yz</a>;dcm[6]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a16e2c28a66a5d6a1f72e5cbdbf3e97b6">zx</a>;dcm[7]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a83c94f51a5c25470b089edc15a38597d">zy</a>;dcm[8]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#aba491fe39528f75bc76ddcdf0e78854c" title="Elements of the matrix.">zz</a>;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325                                 }<span class="comment">//Check if interaction is written in quaternion form and save it in a calculated dcm matrix</span>
<a name="l00326"></a>00326                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetquaternionRows()-&gt;Length&gt;0)
<a name="l00327"></a>00327                                 {
<a name="l00328"></a>00328                                         <span class="comment">//Read parameters</span>
<a name="l00329"></a>00329                                         <span class="keywordtype">double</span> re,ii,ij,ik;
<a name="l00330"></a>00330                                         re=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetquaternionRows()[0]-&gt;re;
<a name="l00331"></a>00331                                         ii=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetquaternionRows()[0]-&gt;i;
<a name="l00332"></a>00332                                         ij=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetquaternionRows()[0]-&gt;j;
<a name="l00333"></a>00333                                         ik=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#abad7330ca4cf2fcd59013d1e3ac94b42">orientation</a>[j]-&gt;GetquaternionRows()[0]-&gt;k;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335                                         <span class="comment">//Make the transformation to dcm</span>
<a name="l00336"></a>00336                                         <a class="code" href="class_spinach_g_u_i_1_1_orientation.html">SpinachGUI::Orientation</a>^  nOrient;
<a name="l00337"></a>00337                                         nOrient=<span class="keyword">gcnew</span> <a class="code" href="class_spinach_g_u_i_1_1_orientation.html">SpinachGUI::Orientation</a>(<span class="keyword">gcnew</span> <a class="code" href="class_spinach_g_u_i_1_1_quaternion.html">SpinachGUI::Quaternion</a>(re,ii,ij,ik));
<a name="l00338"></a>00338                                         <a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html">SpinachGUI::Matrix3x3</a>^ dc=nOrient-&gt;<a class="code" href="class_spinach_g_u_i_1_1_orientation.html#a0b84015f936d299ba8373f009c00592d" title="Function for returning orientation as DCM matrix.">GetAsDCM</a>();
<a name="l00339"></a>00339 
<a name="l00340"></a>00340                                         <span class="comment">//Save to dcm matrix</span>
<a name="l00341"></a>00341                                         dcm[0]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a073f3e87a02ce938d95a784e4781e01e">xx</a>;dcm[1]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a88ebcaa300a6eeecf5f737457bc31788">xy</a>;dcm[2]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#ad77d16a3d314ad637a068f5bf8fa3ecf">xz</a>;dcm[3]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#aa4b0aed4c1ba1d51a7c895c231fdfcf2">yx</a>;
<a name="l00342"></a>00342                                         dcm[4]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a35921945e33551e183e74ccc0718c3f1">yy</a>;dcm[5]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a086b02cfae6dbceebd851af2c767045a">yz</a>;dcm[6]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a16e2c28a66a5d6a1f72e5cbdbf3e97b6">zx</a>;dcm[7]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#a83c94f51a5c25470b089edc15a38597d">zy</a>;dcm[8]=dc-&gt;<a class="code" href="class_spinach_g_u_i_1_1_matrix3x3.html#aba491fe39528f75bc76ddcdf0e78854c" title="Elements of the matrix.">zz</a>;
<a name="l00343"></a>00343                                 };
<a name="l00344"></a>00344 
<a name="l00345"></a>00345                                 Matrix3d result,eigenVectors,eigenVal;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347                                 <span class="comment">//Translate matrixes</span>
<a name="l00348"></a>00348                                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;9;j++) 
<a name="l00349"></a>00349                                 {
<a name="l00350"></a>00350                                         eigenVectors(j)=dcm[j];
<a name="l00351"></a>00351                                         eigenVal(j)=0.0;
<a name="l00352"></a>00352                                 };
<a name="l00353"></a>00353                                 eigenVal(0)=eigenvalues[0];eigenVal(4)=eigenvalues[1];eigenVal(8)=eigenvalues[2];
<a name="l00354"></a>00354 
<a name="l00355"></a>00355                                 <span class="comment">//Calculating tensor from dcm and eigenvalues</span>
<a name="l00356"></a>00356                                 result= (eigenVectors*eigenVal)*eigenVectors.transpose();
<a name="l00357"></a>00357                                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;9;j++) matrix3x3[j]=result(j);
<a name="l00358"></a>00358                         };
<a name="l00359"></a>00359                 };
<a name="l00360"></a>00360 
<a name="l00361"></a>00361                 <span class="comment">//Try to create this interaction</span>
<a name="l00362"></a>00362                 <a class="code" href="class_tensor.html">Tensor</a>^ nInteraction;
<a name="l00363"></a>00363                 <span class="keywordflow">try</span>{
<a name="l00364"></a>00364                         nInteraction=<span class="keyword">gcnew</span> <a class="code" href="class_tensor.html">Tensor</a>(A, B, IntKind, matrix3x3);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366                         <span class="comment">//Check if there is interaction label</span>
<a name="l00367"></a>00367                         <span class="keywordflow">if</span>(!XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;IslabelNull()) 
<a name="l00368"></a>00368                                 nInteraction-&gt;<a class="code" href="class_interaction.html#a907a12141d893f8524d8589c3c096d9c" title="Property Label for giving or setting the label of the interaction.">Label</a>=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;label;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370                         <span class="comment">//Check if there is reference substance</span>
<a name="l00371"></a>00371                         <span class="keywordflow">if</span>(!XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;IsreferenceNull()) 
<a name="l00372"></a>00372                                 nInteraction-&gt;<a class="code" href="class_interaction.html#a3e56d6af56ab5b4e24af1e9ad4e8b3f9" title="The reference substance(only for chemical shifts) of interaction.">reference</a>=XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;reference;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374                         <span class="comment">//Search Units, else set to unknown</span>
<a name="l00375"></a>00375                         if (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;Unitless&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#a01022d82bcd3d4dec2ff0c2063b8a358">Units::Unitless</a>;
<a name="l00376"></a>00376                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;Joule&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#a2cd008c4e58f981ae9d7231b198da9d2">Units::Joule</a>;
<a name="l00377"></a>00377                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;Hz&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#aa52706faabc35b525a484ad1bbd9747a">Units::Hz</a>;
<a name="l00378"></a>00378                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;KHz&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#a0b9c71f04ae56097271d92822e75782d">Units::KHz</a>;
<a name="l00379"></a>00379                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units== <span class="stringliteral">&quot;MHz&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#a0dae09a04eea7c37f558e74dfe99f09b">Units::MHz</a>;
<a name="l00380"></a>00380                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;eV&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#ac8cf1f12a1001abdaadc32938415272a">Units::eV</a>;
<a name="l00381"></a>00381                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;Gauss&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#afa8199bb56a18f4b9bc05a143645a068">Units::Gauss</a>;
<a name="l00382"></a>00382                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;ppm&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#a13d0ca3953991e746670edb678bf1194">Units::ppm</a>;
<a name="l00383"></a>00383                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;Bohr magneton&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#aefde252771ce6c48781414a0ea4aee78">Units::Mi_b</a>;
<a name="l00384"></a>00384                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#a5eb226671b48dc92a93fa4cd002038de">interaction</a>[i]-&gt;units==<span class="stringliteral">&quot;cm^-1&quot;</span> ) nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#a01c5289cdcbbc2caa216eca4b55bfff9">Units::rev_cm</a>;
<a name="l00385"></a>00385                         <span class="keywordflow">else</span>  nInteraction-&gt;<a class="code" href="class_interaction.html#af0b4df61d751c1ddffbfa70843e0c7db" title="Property unit for giving or setting the unit of the interaction.">unit</a>=<a class="code" href="class_units.html#a1aeaf69cbf99eaafefa244db15e51148">Units::Unknown</a>;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387                         <span class="comment">//Set the ref. frame</span>
<a name="l00388"></a>00388                         nInteraction-&gt;<a class="code" href="class_tensor.html#a297aa3cd96e646ffaed3d4547e23ebcb" title="Property matrix3x3 for giving or setting the matrix of the tensor of the interaction.">Frame</a>=refFrame;
<a name="l00389"></a>00389                 }
<a name="l00390"></a>00390                 <span class="keywordflow">catch</span>(String ^ e)  { <span class="keywordflow">throw</span> <span class="keyword">gcnew</span> Exception(<span class="stringliteral">&quot;Problem in Reading XML, creating interaction: &quot;</span>+e);};
<a name="l00391"></a>00391 
<a name="l00392"></a>00392                 <span class="comment">//Add to the interaction collection</span>
<a name="l00393"></a>00393                 <a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>-&gt;Add(nInteraction);
<a name="l00394"></a>00394         };
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 <span class="comment"></span>
<a name="l00399"></a>00399 <span class="comment">/**</span>
<a name="l00400"></a>00400 <span class="comment">* Main function for opening and writing file using the auto-generated spinxml schema file</span>
<a name="l00401"></a>00401 <span class="comment">* @param model The model from where the data will be exported.</span>
<a name="l00402"></a>00402 <span class="comment">*/</span>
<a name="l00403"></a><a class="code" href="class_spin_x_m_l.html#a2778e189bf52993737e5ad1134175778">00403</a> <span class="keywordtype">void</span> <a class="code" href="class_spin_x_m_l.html#a2778e189bf52993737e5ad1134175778">SpinXML::WriteFile</a>(<a class="code" href="class_model.html">Model</a>^% model)
<a name="l00404"></a>00404 {
<a name="l00405"></a>00405  <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>=model;
<a name="l00406"></a>00406  String^ XMLisotope;
<a name="l00407"></a>00407  <span class="keywordtype">int</span> current=0;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409  <span class="comment">//Initializing the serializer using the spinxml schemas</span>
<a name="l00410"></a>00410  XmlSerializer^ serializer = <span class="keyword">gcnew</span> XmlSerializer(spin_system::typeid);
<a name="l00411"></a>00411  <a class="code" href="classspin__system.html">spin_system</a>^ XMLSpinSystem=<span class="keyword">gcnew</span> <a class="code" href="classspin__system.html">spin_system</a>();
<a name="l00412"></a>00412  <a class="code" href="classspin__system__ref.html">spin_system_ref</a>^ XMLSpinSystemRef=<span class="keyword">gcnew</span> <a class="code" href="classspin__system__ref.html">spin_system_ref</a>();
<a name="l00413"></a>00413  XMLSpinSystem-&gt;<a class="code" href="classspin__system.html#ab88f06c624e2c5f1f90683b6894e474d">InitVars</a>();
<a name="l00414"></a>00414  XMLSpinSystemRef-&gt;<a class="code" href="classspin__system__ref.html#acc8705603d9b94ce6ee74e767982aeeb">InitVars</a>();
<a name="l00415"></a>00415 
<a name="l00416"></a>00416  <span class="comment">//Loop over all atoms to export of atoms and coordinates</span>
<a name="l00417"></a>00417  <span class="keywordflow">for each</span> (<span class="keywordtype">int</span> i <span class="keywordflow">in</span> <a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>-&gt;Keys)
<a name="l00418"></a>00418  {
<a name="l00419"></a>00419          spin_system::spinRow^  spinrow;
<a name="l00420"></a>00420          <span class="comment">//Create isotope string from the element and the mass number</span>
<a name="l00421"></a>00421          XMLisotope=System::Convert::ToString(((<a class="code" href="class_atom.html">Atom</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[i])-&gt;isotope-&gt;Mass)+
<a name="l00422"></a>00422                  ((<a class="code" href="class_atom.html">Atom</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[i])-&gt;isotope-&gt;Element;
<a name="l00423"></a>00423          <span class="comment">//Add isotope to the serializer</span>
<a name="l00424"></a>00424          spinrow=XMLSpinSystem-&gt;spin-&gt;AddspinRow(((<a class="code" href="class_atom.html">Atom</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[i])-&gt;ID,
<a name="l00425"></a>00425                  XMLisotope,
<a name="l00426"></a>00426                  ((<a class="code" href="class_atom.html">Atom</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[i])-&gt;Label);
<a name="l00427"></a>00427          <span class="comment">//Add label if exist to serializer</span>
<a name="l00428"></a>00428          <span class="keywordflow">if</span>(((<a class="code" href="class_atom.html">Atom</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[i])-&gt;Label==<span class="keyword">nullptr</span>) 
<a name="l00429"></a>00429                  XMLSpinSystem-&gt;spin[i-1]-&gt;SetlabelNull();
<a name="l00430"></a>00430 
<a name="l00431"></a>00431          <span class="comment">//Add coordinates to serializer</span>
<a name="l00432"></a>00432          spin_system::coordinatesRow^  coordinates;
<a name="l00433"></a>00433          coordinates=XMLSpinSystem-&gt;coordinates-&gt;AddcoordinatesRow(<a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(((<a class="code" href="class_atom.html">Atom</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[i])-&gt;X),
<a name="l00434"></a>00434                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(((<a class="code" href="class_atom.html">Atom</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[i])-&gt;Y),
<a name="l00435"></a>00435                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(((<a class="code" href="class_atom.html">Atom</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a2d177689e21e2dec50129e23e6d83df9">AtomCollection</a>[i])-&gt;Z),
<a name="l00436"></a>00436                  spinrow);
<a name="l00437"></a>00437  }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439  <span class="comment">//Loop over all interactions to export of interactions</span>
<a name="l00440"></a>00440  <span class="keywordflow">for each</span> (<span class="keywordtype">int</span> i <span class="keywordflow">in</span> <a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>-&gt;Keys)
<a name="l00441"></a>00441         {<span class="comment">//Every interaction except bonds</span>
<a name="l00442"></a>00442         <span class="keywordflow">if</span>(((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;IntKind!=<a class="code" href="_model_8h.html#a0c402bd678cea44c9d1fdaf49d6f6b8ea1203807f6d26bc8df1724b77efbcf351">InteractionKind::CBond</a>)
<a name="l00443"></a>00443                 {
<a name="l00444"></a>00444                         spin_system::interactionRow^  interrow;
<a name="l00445"></a>00445                         <a class="code" href="class_tensor.html">Tensor</a>^ interact=(<a class="code" href="class_tensor.html">Tensor</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i];
<a name="l00446"></a>00446                         <span class="keywordtype">int</span> B_ID;
<a name="l00447"></a>00447                         String^ label;
<a name="l00448"></a>00448                         String^ reference;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450                         <span class="comment">//Check if label exist else set as label</span>
<a name="l00451"></a>00451                         <span class="keywordflow">if</span>(((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;Label==<span class="keyword">nullptr</span>) label=<span class="stringliteral">&quot;label&quot;</span>;
<a name="l00452"></a>00452                         <span class="keywordflow">else</span> label=((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;Label;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454                         <span class="comment">//Check if B atom exist else set as -1</span>
<a name="l00455"></a>00455                         <span class="keywordflow">if</span>(((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;B==<span class="keyword">nullptr</span>) {B_ID=-1;}
<a name="l00456"></a>00456                         <span class="keywordflow">else</span> B_ID=((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;B-&gt;ID;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458                         <span class="comment">//check if reference element exist else set to ref</span>
<a name="l00459"></a>00459                         <span class="keywordflow">if</span>(((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;reference==<span class="keyword">nullptr</span>) {reference=<span class="stringliteral">&quot;ref&quot;</span>;}
<a name="l00460"></a>00460                         <span class="keywordflow">else</span> reference=((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;reference;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462                         <span class="comment">//Constructor of interaction </span>
<a name="l00463"></a>00463                         interrow=XMLSpinSystem-&gt;interaction-&gt;AddinteractionRow(
<a name="l00464"></a>00464                                 ((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;IntKind.ToString()-&gt;ToLower(),
<a name="l00465"></a>00465                                 ((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;ID,
<a name="l00466"></a>00466                                 ((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;unit-&gt;get_name(),
<a name="l00467"></a>00467                                 ((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;A-&gt;ID,
<a name="l00468"></a>00468                                 B_ID,
<a name="l00469"></a>00469                                 ((<a class="code" href="class_tensor.html">Tensor</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;Frame-&gt;getID(),
<a name="l00470"></a>00470                                 label,
<a name="l00471"></a>00471                                 reference,
<a name="l00472"></a>00472                                 NULL); <span class="comment">//Everything will in Tensor form.</span>
<a name="l00473"></a>00473 
<a name="l00474"></a>00474                         <span class="comment">//Set the fields that are missing null</span>
<a name="l00475"></a>00475                         <span class="keywordflow">if</span>(((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;B==<span class="keyword">nullptr</span>) 
<a name="l00476"></a>00476                                 XMLSpinSystem-&gt;interaction[current]-&gt;Setspin_bNull();
<a name="l00477"></a>00477 
<a name="l00478"></a>00478                         <span class="keywordflow">if</span>(((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;Label==<span class="keyword">nullptr</span>) 
<a name="l00479"></a>00479                                 XMLSpinSystem-&gt;interaction[current]-&gt;SetlabelNull();
<a name="l00480"></a>00480 
<a name="l00481"></a>00481                         <span class="keywordflow">if</span>(((<a class="code" href="class_interaction.html">Interaction</a>^)<a class="code" href="_spin_x_m_l_8cpp.html#a5cbb61ec3949904f6d01991168849abf">InteractionCollection</a>[i])-&gt;reference==<span class="keyword">nullptr</span>) 
<a name="l00482"></a>00482                                 XMLSpinSystem-&gt;interaction[current]-&gt;SetreferenceNull();
<a name="l00483"></a>00483 
<a name="l00484"></a>00484                         <span class="comment">//Always interaction will not be scalar</span>
<a name="l00485"></a>00485                         XMLSpinSystem-&gt;interaction[current]-&gt;SetscalarNull();
<a name="l00486"></a>00486 
<a name="l00487"></a>00487                         <span class="comment">//Set interaction as  tensor always</span>
<a name="l00488"></a>00488                         spin_system::tensorRow^  tensrow;
<a name="l00489"></a>00489                         tensrow=XMLSpinSystem-&gt;tensor-&gt;AddtensorRow(<a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[0]),
<a name="l00490"></a>00490                                 <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[1]),
<a name="l00491"></a>00491                                 <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[2]),
<a name="l00492"></a>00492                                 <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[3]),
<a name="l00493"></a>00493                                 <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[4]),
<a name="l00494"></a>00494                                 <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[5]),
<a name="l00495"></a>00495                                 <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[6]),
<a name="l00496"></a>00496                                 <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[7]),
<a name="l00497"></a>00497                                 <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(interact-&gt;matrix3x3[8]),
<a name="l00498"></a>00498                                 XMLSpinSystem-&gt;interaction[current]);
<a name="l00499"></a>00499 
<a name="l00500"></a>00500                         <span class="comment">//increase Interaction ID</span>
<a name="l00501"></a>00501                         current++;
<a name="l00502"></a>00502         };
<a name="l00503"></a>00503  };
<a name="l00504"></a>00504 
<a name="l00505"></a>00505  current=0;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507  <span class="comment">//Loop over all ref. frames to export of reference frame</span>
<a name="l00508"></a>00508  <span class="keywordflow">for each</span> (<span class="keywordtype">int</span> i <span class="keywordflow">in</span> <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>-&gt;<a class="code" href="class_reference_frames_dictionary.html#ac4bf3754525cbdb370387718ad4dd579" title="Property Keys for giving the keys of the collection.">Keys</a>)
<a name="l00509"></a>00509  {
<a name="l00510"></a>00510          spin_system_ref::reference_frameRow ^ refFrame;
<a name="l00511"></a>00511          <a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ frame=<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[i];
<a name="l00512"></a>00512          String^ label;
<a name="l00513"></a>00513          <span class="keywordtype">int</span> parent;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515          <span class="comment">//Check if label exist else set as label</span>
<a name="l00516"></a>00516          <span class="keywordflow">if</span>(((<a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ )<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[i])-&gt;Label==<span class="keyword">nullptr</span>) label=<span class="stringliteral">&quot;label&quot;</span>;
<a name="l00517"></a>00517          <span class="keywordflow">else</span> label=((<a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ )<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[i])-&gt;Label;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519          <span class="comment">//Check if parent frame exist else set as 0(root)</span>
<a name="l00520"></a>00520          <span class="keywordflow">if</span>(((<a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ )<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[i])-&gt;ParentRefFrame==<span class="keyword">nullptr</span>) parent=0;
<a name="l00521"></a>00521          <span class="keywordflow">else</span> parent=((<a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ )<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[i])-&gt;ParentRefFrame-&gt;getID();
<a name="l00522"></a>00522 
<a name="l00523"></a>00523          <span class="comment">//Set the ref. frame in the serializer</span>
<a name="l00524"></a>00524          refFrame=
<a name="l00525"></a>00525                  XMLSpinSystemRef-&gt;reference_frame-&gt;Addreference_frameRow(
<a name="l00526"></a>00526                  <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[i]-&gt;getID(), parent, label);
<a name="l00527"></a>00527          spin_system_ref::directionRow ^ direction=XMLSpinSystemRef-&gt;direction-&gt;AdddirectionRow(refFrame);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529          <span class="comment">//Set the fields that are missing null</span>
<a name="l00530"></a>00530          <span class="keywordflow">if</span>(((<a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ )<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[i])-&gt;Label==<span class="keyword">nullptr</span>) 
<a name="l00531"></a>00531                  XMLSpinSystemRef-&gt;reference_frame[current]-&gt;SetlabelNull();
<a name="l00532"></a>00532          <span class="keywordflow">if</span>(((<a class="code" href="class_reference_frame.html">ReferenceFrame</a>^ )<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a16ab6e7e7d34bd4bb7d0d32b59f6770a" title="Main function for opening and reading file.">SystemModel</a>-&gt;<a class="code" href="class_model.html#adc069c415325e10c5c452421d0578564" title="The collection of reference frames in the model.">RefFrameCollection</a>[i])-&gt;ParentRefFrame==<span class="keyword">nullptr</span>) 
<a name="l00533"></a>00533                  XMLSpinSystemRef-&gt;reference_frame[current]-&gt;Setparent_reference_frame_idNull();
<a name="l00534"></a>00534 
<a name="l00535"></a>00535          <span class="comment">//Set the direction of ref. frame from the rotation matrix</span>
<a name="l00536"></a>00536          spin_system_ref::dcmRow^ dcmrow;
<a name="l00537"></a>00537          dcmrow=XMLSpinSystemRef-&gt;dcm-&gt;AdddcmRow(<a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[0]),
<a name="l00538"></a>00538                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[1]),
<a name="l00539"></a>00539                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[2]),
<a name="l00540"></a>00540                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[3]),
<a name="l00541"></a>00541                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[4]),
<a name="l00542"></a>00542                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[5]),
<a name="l00543"></a>00543                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[6]),
<a name="l00544"></a>00544                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[7]),
<a name="l00545"></a>00545                  <a class="code" href="_spin_x_m_l_8cpp.html#a404358c1af3946d54023374d8bd7c5d8">To_Double</a>(frame-&gt;<a class="code" href="class_reference_frame.html#a471c661689d5d5c6d6a391ad8cb69f7b" title="The observable rotation matrix of the reference frame.">rotation</a>[8]),
<a name="l00546"></a>00546                  XMLSpinSystemRef-&gt;direction[current]);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548          <span class="comment">//increase Interaction ID</span>
<a name="l00549"></a>00549          current++;
<a name="l00550"></a>00550  };
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 
<a name="l00553"></a>00553    <span class="comment">//Some Settings for the xml format</span>
<a name="l00554"></a>00554    XmlWriterSettings^ settings=<span class="keyword">gcnew</span> XmlWriterSettings();
<a name="l00555"></a>00555    settings-&gt;Indent=<span class="keyword">true</span>;
<a name="l00556"></a>00556    settings-&gt;ConformanceLevel=Xml::ConformanceLevel::Fragment;
<a name="l00557"></a>00557    XmlWriter^ writer = XmlWriter::Create( <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a7be06c655425ce64a0f42da320c436cf" title="The stream that has the file which will be written.">WritingFile</a>, settings);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559    <span class="comment">//Export both schemas to xml and close files</span>
<a name="l00560"></a>00560    XMLSpinSystem-&gt;WriteXml(writer); 
<a name="l00561"></a>00561    XMLSpinSystemRef-&gt;WriteXml(writer); 
<a name="l00562"></a>00562    writer-&gt;Close();
<a name="l00563"></a>00563    <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a7be06c655425ce64a0f42da320c436cf" title="The stream that has the file which will be written.">WritingFile</a>-&gt;Close();
<a name="l00564"></a>00564 
<a name="l00565"></a>00565    <span class="comment">//Reopen the file to join properly the two schemas, reading it as normat text</span>
<a name="l00566"></a>00566    <span class="comment">//not perfect</span>
<a name="l00567"></a>00567    StreamReader^ tempFile = <span class="keyword">gcnew</span> StreamReader(<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>);
<a name="l00568"></a>00568    String ^ temp=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00569"></a>00569    String ^ <span class="keyword">final</span>=<span class="stringliteral">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&quot;</span>+<span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571    <span class="comment">//Read the file line by line until the end</span>
<a name="l00572"></a>00572    <span class="keywordflow">while</span>(!tempFile-&gt;EndOfStream)
<a name="l00573"></a>00573    {
<a name="l00574"></a>00574            <span class="comment">//Read the line</span>
<a name="l00575"></a>00575            temp=tempFile-&gt;ReadLine();
<a name="l00576"></a>00576 
<a name="l00577"></a>00577            <span class="comment">//If not containing the end of the first schema or the begining of the second schema</span>
<a name="l00578"></a>00578            <span class="comment">//(will not copy this line)</span>
<a name="l00579"></a>00579            <span class="keywordflow">if</span>(!temp-&gt;Contains(<span class="stringliteral">&quot;&lt;/spin_system&gt;&quot;</span>) &amp;&amp; !temp-&gt;Contains(<span class="stringliteral">&quot;&lt;spin_system_ref&gt;&quot;</span>))
<a name="l00580"></a>00580            {
<a name="l00581"></a>00581                    <span class="comment">//Replave the name of the second at the end, with the name of the first</span>
<a name="l00582"></a>00582                    <span class="keywordflow">if</span>(temp-&gt;Contains(<span class="stringliteral">&quot;&lt;/spin_system_ref&gt;&quot;</span>)) temp=<span class="stringliteral">&quot;&lt;/spin_system&gt;&quot;</span>;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584                    <span class="comment">//Add the line to the final string</span>
<a name="l00585"></a>00585                    <span class="keyword">final</span>+=temp+<span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00586"></a>00586            };
<a name="l00587"></a>00587    };
<a name="l00588"></a>00588 
<a name="l00589"></a>00589   <span class="comment">//Close the file</span>
<a name="l00590"></a>00590   tempFile-&gt;Close();
<a name="l00591"></a>00591 
<a name="l00592"></a>00592   <span class="comment">//Reopen the file and clean it</span>
<a name="l00593"></a>00593   <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a7be06c655425ce64a0f42da320c436cf" title="The stream that has the file which will be written.">WritingFile</a> =<span class="keyword">gcnew</span> StreamWriter(<a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a8878afa6cc5a9adbefed2d578b1a9299" title="The name of the File to read or write.">FileName</a>);
<a name="l00594"></a>00594   <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a7be06c655425ce64a0f42da320c436cf" title="The stream that has the file which will be written.">WritingFile</a>-&gt;Flush();
<a name="l00595"></a>00595 
<a name="l00596"></a>00596   <span class="comment">//Write the final string and close it</span>
<a name="l00597"></a>00597   <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a7be06c655425ce64a0f42da320c436cf" title="The stream that has the file which will be written.">WritingFile</a>-&gt;Write(<span class="keyword">final</span>);
<a name="l00598"></a>00598   <a class="code" href="class_spinach_g_u_i_1_1_i_o_spin_system.html#a7be06c655425ce64a0f42da320c436cf" title="The stream that has the file which will be written.">WritingFile</a>-&gt;Close();
<a name="l00599"></a>00599 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sat Apr 25 2015 18:33:58 for Spinach GUI by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
